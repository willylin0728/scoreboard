<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è¨˜åˆ†æ¿æ§åˆ¶å€ï¼ˆè¯ç›Ÿç‰ˆ + Firebase åŒæ­¥ï¼‰</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .container {
      background: #ffffff;
      max-width: 1100px;
      width: 100%;
      padding: 20px 24px 28px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
    }
    h1 {
      text-align: center;
      margin: 0 0 8px;
      font-size: 24px;
    }
    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-bottom: 16px;
    }
    .top-bar label { font-size: 14px; }
    .top-bar input[type="text"] {
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 14px;
    }
    .btn {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-primary { background:#007bff;color:#fff; }
    .btn-reset { background:#6c757d;color:#fff; }
    .btn-sort  { background:#17a2b8;color:#fff; }
    .btn-small { padding:4px 8px;font-size:12px; }
    .btn:hover { opacity:.9; }
    .layout {
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:20px;
      align-items:flex-start;
    }
    .panel {
      background:#fafafa;
      border-radius:12px;
      padding:12px 14px 16px;
      border:1px solid #e0e0e0;
    }
    .panel-title {
      font-size:15px;
      font-weight:600;
      margin-bottom:6px;
    }
    .panel-subtitle {
      font-size:12px;
      color:#777;
      margin-bottom:10px;
    }

    .alliance-block {
      border-radius:10px;
      border:1px solid #ddd;
      margin-bottom:10px;
      background:#fff;
    }
    .alliance-header {
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-bottom:1px solid #eee;
      background:#f3f3f3;
    }
    .alliance-header input {
      flex:1;
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:13px;
    }
    .alliance-header span {
      font-size:12px;
      color:#555;
      white-space:nowrap;
    }
    .alliance-body {
      padding:6px 8px 8px;
    }

    .player-row {
      display:grid;
      grid-template-columns: 1.7fr 0.6fr 2.1fr 0.4fr;
      gap:6px;
      align-items:center;
      padding:3px 0;
    }
    .player-row:nth-child(odd){ background:#fafafa; }
    .player-row:nth-child(even){ background:#f0f0f0; }

    .name-input {
      width:100%;
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #ccc;
      font-size:13px;
      box-sizing:border-box;
    }
    .name-input:focus {
      outline:none;
      border-color:#007bff;
      box-shadow:0 0 0 2px rgba(0,123,255,.15);
    }
    .score-box {
      text-align:center;
      font-weight:bold;
      font-size:16px;
    }
    .buttons {
      display:flex;
      flex-wrap:nowrap;     /* â— ä¸æ›è¡Œ */
      gap:3px;
      justify-content:center;
      overflow-x:auto;      /* â— è¢å¹•å¤ªçª„æ™‚å…è¨±æ°´å¹³æ²å‹• */
    }
    .btn-plus,.btn-minus {
      padding:2px 4px;
      font-size:11px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      min-width:28px;
    }
    .btn-plus  { background:#28a745;color:#fff; }
    .btn-minus { background:#dc3545;color:#fff; }
    .btn-del {
      background:#ff9800;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      padding:2px 6px;
      font-size:12px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{ background:#e9ecef; }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #ddd;
      text-align:center;
    }
    tbody tr:nth-child(odd){ background:#fff; }
    tbody tr:nth-child(even){ background:#f8f9fa; }
    .rank-col{ width:40px; }
    .ally-col{ width:90px; }
    .name-col{ text-align:left; }

    .toolbar-bottom{
      display:flex;
      justify-content:flex-start;
      gap:8px;
      align-items:center;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .small-note{
      font-size:12px;
      color:#777;
    }
    @media(max-width:960px){
      .layout{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>è¨˜åˆ†æ¿æ§åˆ¶å€ï¼ˆå…­å¤§è¯ç›Ÿï¼‰</h1>
    <div class="subtitle">
      æˆ¿é–“åç¨±ç›¸åŒå³å¯åŒæ­¥ï¼›æ¯å€‹è¯ç›Ÿå¯è‡ªç”±æ–°å¢ / åˆªé™¤ç©å®¶ã€‚
    </div>

    <div class="top-bar">
      <label>æˆ¿é–“åç¨±(room)ï¼š</label>
      <input type="text" id="roomInput" placeholder="ä¾‹å¦‚ï¼šclassA" />
      <button class="btn btn-primary" id="changeRoomBtn">åˆ‡æ›æˆ¿é–“</button>
      <button class="btn btn-reset" id="resetScoreBtn">å…¨éƒ¨åˆ†æ•¸æ­¸é›¶</button>
    </div>

    <div class="layout">
      <!-- å·¦å´ï¼šå…­å€‹è¯ç›Ÿæ§åˆ¶å€ -->
      <div class="panel">
        <div class="panel-title">è¯ç›Ÿèˆ‡ç©å®¶ç®¡ç†</div>
        <div class="panel-subtitle">
          æ¯å€‹è¯ç›Ÿå¯æ”¹åï¼ŒæŒ‰ã€Œæ–°å¢ç©å®¶ã€åŠ å…¥ï¼ŒğŸ—‘ åˆªé™¤è©²ç©å®¶ã€‚
        </div>
        <div id="alliancesContainer"></div>
      </div>

      <!-- å³å´ï¼šç¸½æ’è¡Œæ¦œé è¦½ -->
      <div class="panel">
        <div class="panel-title">ç¸½æ’è¡Œæ¦œé è¦½</div>
        <div class="panel-subtitle">
          view.html è§€æˆ°é æœƒé¡¯ç¤ºèˆ‡æ­¤å€ç›¸åŒçš„å…§å®¹ã€‚
        </div>
        <table>
          <thead>
            <tr>
              <th class="rank-col">åæ¬¡</th>
              <th class="ally-col">è¯ç›Ÿ</th>
              <th class="name-col">ç©å®¶</th>
              <th>åˆ†æ•¸</th>
            </tr>
          </thead>
          <tbody id="viewBody"></tbody>
        </table>

        <div class="toolbar-bottom">
          <button class="btn btn-sort" id="sortBtn">æŸ¥çœ‹çµæœï¼ˆç”±é«˜åˆ°ä½æ’åºï¼‰</button>
          <span class="small-note" id="sortNote">ç›®å‰ï¼šä¾åŠ å…¥é †åºé¡¯ç¤º</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + é‚è¼¯ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ===== åœ¨é€™è£¡è²¼ä¸Šä½ çš„ firebaseConfig =====
    const firebaseConfig = {
      apiKey: "AIzaSyA1bn1o--CZs8R9z66yWja5jtFgWgsYcjc",
      authDomain: "scoreboard-project-3c57c.firebaseapp.com",
      projectId: "scoreboard-project-3c57c",
      storageBucket: "scoreboard-project-3c57c.firebasestorage.app",
      messagingSenderId: "927335969684",
      appId: "1:927335969684:web:7f3be6f470301def8f9581",
      measurementId: "G-0ZXW9PQKVV"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // DOM
    const roomInput          = document.getElementById("roomInput");
    const changeRoomBtn      = document.getElementById("changeRoomBtn");
    const resetScoreBtn      = document.getElementById("resetScoreBtn");
    const alliancesContainer = document.getElementById("alliancesContainer");
    const viewBody           = document.getElementById("viewBody");
    const sortBtn            = document.getElementById("sortBtn");
    const sortNote           = document.getElementById("sortNote");

    // æˆ¿é–“ id
    const urlParams = new URLSearchParams(location.search);
    const urlRoom   = urlParams.get("room");
    roomInput.value = urlRoom || "default";
    let roomId      = roomInput.value.trim() || "default";
    let roomRef     = ref(db, "rooms/" + roomId);

    // ç‹€æ…‹
    let alliances    = []; // [{id,name,players:[{id,name,score}]}]
    let isSortedView = false;
    let nextPlayerId = 1;
    let isWriting    = false;
    let hasInitial   = false;

    // å»ºç«‹é è¨­å…­å¤§è¯ç›Ÿ
    function initDefaultAlliances() {
      alliances = [];
      const names = ["ç¬¬ä¸€è¯ç›Ÿ","ç¬¬äºŒè¯ç›Ÿ","ç¬¬ä¸‰è¯ç›Ÿ","ç¬¬å››è¯ç›Ÿ","ç¬¬äº”è¯ç›Ÿ","ç¬¬å…­è¯ç›Ÿ"];
      for (let i = 0; i < 6; i++) {
        alliances.push({
          id: i + 1,
          name: names[i],
          players: []
        });
      }
      nextPlayerId = 1;
    }

    function calcNextIdFromData() {
      let maxId = 0;
      alliances.forEach(a => {
        a.players.forEach(p => {
          if (typeof p.id === "number" && p.id > maxId) maxId = p.id;
        });
      });
      return maxId + 1;
    }

    // ç›£è½ Firebase
    function attachRoomListener() {
      onValue(roomRef, (snapshot) => {
        if (isWriting) return;
        const data = snapshot.val();
        if (data && Array.isArray(data.alliances)) {
          alliances    = data.alliances;
          isSortedView = !!data.isSortedView;
          nextPlayerId = data.nextPlayerId || calcNextIdFromData();
        } else {
          // èˆŠè³‡æ–™æˆ–ç©ºè³‡æ–™ â†’ åˆå§‹åŒ–
          initDefaultAlliances();
          writeState();
        }
        hasInitial = true;
        renderAll();
      });
    }

    attachRoomListener();

    function writeState() {
      const data = {
        alliances,
        isSortedView,
        nextPlayerId
      };
      isWriting = true;
      set(roomRef, data).finally(() => {
        isWriting = false;
      });
    }

    function renderAll() {
      renderAlliancesControl();
      renderViewTable();
      updateSortUI();
    }

    // æ¸²æŸ“å·¦å´è¯ç›Ÿæ§åˆ¶å€
    function renderAlliancesControl() {
      alliancesContainer.innerHTML = "";
      alliances.forEach((ally, allyIndex) => {
        const block = document.createElement("div");
        block.className = "alliance-block";

        const header = document.createElement("div");
        header.className = "alliance-header";

        const nameInput = document.createElement("input");
        nameInput.value = ally.name;
        nameInput.addEventListener("input", () => {
          alliances[allyIndex].name = nameInput.value || `ç¬¬${ally.id}è¯ç›Ÿ`;
          writeState();
          renderViewTable();
        });

        const countSpan = document.createElement("span");
        countSpan.textContent = `æˆå“¡ï¼š${ally.players.length} äºº`;

        const addBtn = document.createElement("button");
        addBtn.className = "btn btn-primary btn-small";
        addBtn.textContent = "æ–°å¢ç©å®¶";
        addBtn.addEventListener("click", () => {
          const newPlayer = {
            id: nextPlayerId++,
            name: "æ–°ç©å®¶ " + nextPlayerId,
            score: 0
          };
          alliances[allyIndex].players.push(newPlayer);
          writeState();
          renderAll(); // é‡æ–°ç•«ï¼Œæ›´æ–°äººæ•¸
        });

        header.appendChild(nameInput);
        header.appendChild(countSpan);
        header.appendChild(addBtn);

        const body = document.createElement("div");
        body.className = "alliance-body";

        ally.players.forEach((player, pIndex) => {
          const row = document.createElement("div");
          row.className = "player-row";

          const nameInputP = document.createElement("input");
          nameInputP.className = "name-input";
          nameInputP.value = player.name;
          nameInputP.placeholder = "ç©å®¶åç¨±";
          nameInputP.addEventListener("input", () => {
            alliances[allyIndex].players[pIndex].name =
              nameInputP.value || `ç©å®¶ ${player.id}`;
            writeState();
            renderViewTable();
          });

          const scoreBox = document.createElement("div");
          scoreBox.className = "score-box";
          scoreBox.textContent = player.score;

          const btnArea = document.createElement("div");
          btnArea.className = "buttons";

          const deltas = [-3,-2,-1,1,2,3];
          deltas.forEach(d => {
            const btn = document.createElement("button");
            btn.className = d > 0 ? "btn-plus" : "btn-minus";
            btn.textContent = (d>0?"+":"") + d;
            btn.addEventListener("click", () => {
              alliances[allyIndex].players[pIndex].score += d;
              scoreBox.textContent =
                alliances[allyIndex].players[pIndex].score;
              writeState();
              renderViewTable();
            });
            btnArea.appendChild(btn);
          });

          const delBtn = document.createElement("button");
          delBtn.className = "btn-del";
          delBtn.textContent = "ğŸ—‘";
          delBtn.title = "åˆªé™¤é€™ä½ç©å®¶";
          delBtn.addEventListener("click", () => {
            alliances[allyIndex].players.splice(pIndex,1);
            writeState();
            renderAll();
          });

          row.appendChild(nameInputP);
          row.appendChild(scoreBox);
          row.appendChild(btnArea);
          row.appendChild(delBtn);

          body.appendChild(row);
        });

        block.appendChild(header);
        block.appendChild(body);
        alliancesContainer.appendChild(block);
      });
    }

    // æ¸²æŸ“å³å´æ’è¡Œæ¦œ
    function renderViewTable() {
      viewBody.innerHTML = "";

      // æŠŠå…­å€‹è¯ç›Ÿå±•å¹³æˆä¸€å€‹é™£åˆ—
      let allPlayers = [];
      alliances.forEach(ally => {
        ally.players.forEach(p => {
          allPlayers.push({
            id: p.id,
            name: p.name,
            score: p.score,
            allianceName: ally.name
          });
        });
      });

      let dataToShow;
      if (isSortedView) {
        dataToShow = [...allPlayers].sort((a,b) => {
          if (b.score !== a.score) return b.score - a.score;
          return a.id - b.id;
        });
      } else {
        dataToShow = allPlayers; // åŸå§‹åŠ å…¥é †åº
      }

      dataToShow.forEach((player, idx) => {
        const tr = document.createElement("tr");

        const tdRank = document.createElement("td");
        const tdAlly = document.createElement("td");
        const tdName = document.createElement("td");
        const tdScore= document.createElement("td");

        tdRank.textContent  = idx + 1;
        tdAlly.textContent  = player.allianceName;
        tdName.textContent  = player.name;
        tdName.className    = "name-col";
        tdScore.textContent = player.score;

        tr.appendChild(tdRank);
        tr.appendChild(tdAlly);
        tr.appendChild(tdName);
        tr.appendChild(tdScore);
        viewBody.appendChild(tr);
      });
    }

    function updateSortUI() {
      if (isSortedView) {
        sortBtn.textContent = "ä¾åŠ å…¥é †åºé¡¯ç¤º";
        sortNote.textContent = "ç›®å‰ï¼šä¾åˆ†æ•¸ç”±é«˜åˆ°ä½æ’åº";
      } else {
        sortBtn.textContent = "æŸ¥çœ‹çµæœï¼ˆç”±é«˜åˆ°ä½æ’åºï¼‰";
        sortNote.textContent = "ç›®å‰ï¼šä¾åŠ å…¥é †åºé¡¯ç¤º";
      }
    }

    // äº‹ä»¶
    sortBtn.addEventListener("click", () => {
      isSortedView = !isSortedView;
      updateSortUI();
      writeState();
      renderViewTable();
    });

    resetScoreBtn.addEventListener("click", () => {
      alliances.forEach(a => {
        a.players.forEach(p => p.score = 0);
      });
      writeState();
      renderAll();
    });

    changeRoomBtn.addEventListener("click", () => {
      const newRoom = roomInput.value.trim() || "default";
      if (newRoom === roomId) return;
      roomId  = newRoom;
      roomRef = ref(db, "rooms/" + roomId);
      initDefaultAlliances();
      writeState();
      // é‡æ–°ç›£è½æ–°çš„æˆ¿é–“ï¼ˆç°¡å–®èµ·è¦‹é‡æ–°è¼‰å…¥é é¢ï¼‰
      location.search = "?room=" + encodeURIComponent(roomId);
    });
  </script>
</body>
</html>
